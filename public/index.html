<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Freelance Signal Bot ‚Äì Live Leads</title>
  <style>
    /* keep your styles ‚Äî truncated for brevity */
    body{font-family:system-ui,Segoe UI,Tahoma,Arial;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;padding:20px}
    .container{max-width:1200px;margin:0 auto;padding:20px;background:#fff;border-radius:12px;box-shadow:0 4px 20px rgba(0,0,0,.1)}
    .header{text-align:center;margin-bottom:30px}
    .header h1{color:#333;font-size:2.5em;margin-bottom:10px}
    .header p{color:#666;font-size:1.1em;margin-bottom:20px}
    .demo-container{display:grid;grid-template-columns:1fr 1fr;gap:30px}
    .dashboard{background:#f9f9f9;padding:20px;border-radius:8px;box-shadow:inset 0 1px 3px rgba(0,0,0,.05)}
    .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:15px;margin-bottom:25px}
    .stat-card{background:#fff;padding:15px;border-radius:8px;text-align:center;box-shadow:0 2px 5px rgba(0,0,0,.08)}
    .stat-number{font-size:2.2em;font-weight:700;color:#4a4a4a}
    .stat-label{font-size:.9em;color:#888;text-transform:uppercase;letter-spacing:.5px}
    .activity-log{background:#fff;padding:15px;border-radius:8px;box-shadow:0 2px 5px rgba(0,0,0,.08);max-height:300px;overflow-y:auto}
    .log-entry{padding:8px 0;border-bottom:1px solid #eee;font-size:.9em;color:#555}
    .log-entry:last-child{border-bottom:none}
    .log-entry.info{color:#007bff}
    .log-entry.success{color:#28a745}
    .discord-mockup{background:#36393f;border-radius:8px;display:flex;flex-direction:column;overflow:hidden;box-shadow:0 4px 15px rgba(0,0,0,.2)}
    .discord-header{background:#2f3136;color:#fff;padding:12px 15px;font-weight:700;font-size:1.1em;border-bottom:1px solid #222}
    .discord-content{flex-grow:1;padding:15px;overflow-y:auto;display:flex;flex-direction:column;gap:15px}
    .lead-card{background:#2f3136;border-radius:8px;padding:15px;color:#dcddde;font-size:.9em;border-left:4px solid;display:flex;flex-direction:column}
    .lead-card.high-score{border-left-color:#22c55e}
    .lead-card.medium-score{border-left-color:#0ea5e9}
    .lead-card.low-score{border-left-color:#facc15}
    .lead-header{margin-bottom:10px}
    .lead-title{font-weight:700;color:#fff;font-size:1.1em;margin-bottom:5px}
    .lead-content{color:#b9bbbe;line-height:1.4}
    .lead-fields{display:grid;grid-template-columns:repeat(auto-fit,minmax(100px,1fr));gap:10px;margin-top:10px;padding-top:10px;border-top:1px solid #444}
    .field{display:flex;flex-direction:column}
    .field-label{font-size:.75em;color:#8e9297;text-transform:uppercase;margin-bottom:3px}
    .field-value{font-size:.9em;color:#dcddde;word-break:break-word}
    .lead-footer{display:flex;justify-content:space-between;margin-top:15px;font-size:.75em;color:#8e9297}
    @media (max-width:768px){.demo-container{grid-template-columns:1fr}}
    /* New style for tech stack to allow wrapping */
    .field-value.tech-stack {
      white-space: normal;
    }
    .auth-section {
      margin-top: 12px;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 10px;
    }
    .auth-section input {
      padding: 8px 12px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }
    .auth-section button {
      padding: 8px 12px;
      border-radius: 6px;
      border: none;
      color: #fff;
      cursor: pointer;
      transition: background-color 0.2s ease;
    }
    .auth-section button.primary {
      background: #111;
    }
    .auth-section button.primary:hover {
      background: #333;
    }
    .auth-section button.secondary {
      background: #dc3545;
    }
    .auth-section button.secondary:hover {
      background: #c82333;
    }
    .auth-section button.buy-button {
      background: #0ea5e9;
    }
    .auth-section button.buy-button:hover {
      background: #0284c7;
    }
    .auth-section button.buy-annual {
      background: #22c55e;
    }
    .auth-section button.buy-annual:hover {
      background: #16a34a;
    }
    .user-info {
      color: #333;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ü§ñ Freelance Signal Bot</h1>
      <p>Real-time qualified leads (Reddit) ‚Äî 3-day free trial, then $9.99/mo or $85/yr</p>
      <div class="auth-section">
        <div id="auth-logged-out">
          <input id="email" type="email" placeholder="you@example.com"/>
          <button id="signup-login-btn" class="primary">Sign Up / Log In</button>
        </div>
        <div id="auth-logged-in" style="display: none;">
          <span class="user-info" id="user-email"></span>
          <button id="logout-btn" class="secondary">Log Out</button>
          <button id="buy-monthly" class="buy-button">$9.99/mo</button>
          <button id="buy-annual" class="buy-annual">$85/year</button>
        </div>
      </div>
    </div>

    <div class="demo-container">
      <div class="dashboard">
        <div class="stats-grid">
          <div class="stat-card"><div class="stat-number" id="totalScanned">0</div><div class="stat-label">Posts Scanned (DB)</div></div>
          <div class="stat-card"><div class="stat-number" id="qualifiedLeads">0</div><div class="stat-label">Qualified Leads</div></div>
          <div class="stat-card"><div class="stat-number" id="avgScore">0.0</div><div class="stat-label">Average Score</div></div>
        </div>
        <div class="activity-log" id="log"><h3 style="margin-bottom:15px;color:#333;">üìä Activity</h3></div>
      </div>

      <div class="discord-mockup">
        <div class="discord-header"># üéØ-qualified-leads</div>
        <div class="discord-content" id="discordContent"></div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const SUPABASE_URL = "https://slosefmnqwohkzeiblbb.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNsb3NlZm1ucXdvaGt6ZWlibGJiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTIzNTM3NjIsImV4cCI6MjA2NzkyOTc2Mn0.2Ozs9SUw8VLSe5MhetsuLQ3gMlOS420homDBApVTAfU";

    const supabase = Supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const discordContent = document.getElementById('discordContent');
    const log = document.getElementById('log');
    const emailInput = document.getElementById('email');
    const signupLoginBtn = document.getElementById('signup-login-btn');
    const logoutBtn = document.getElementById('logout-btn');
    const authLoggedOut = document.getElementById('auth-logged-out');
    const authLoggedIn = document.getElementById('auth-logged-in');
    const userEmailSpan = document.getElementById('user-email');
    const buyMonthlyBtn = document.getElementById('buy-monthly');
    const buyAnnualBtn = document.getElementById('buy-annual');

    let currentUserId = null; // Store the current Supabase user ID

    function logLine(text, cls='info'){
      const div=document.createElement('div');
      div.className='log-entry '+cls;
      div.textContent = `[${new Date().toLocaleTimeString()}] ${text}`;
      log.appendChild(div);
      log.scrollTop = log.scrollHeight; // Auto-scroll to bottom
    }

    function leadCard(lead){
      const border = lead.score >= 8 ? 'high-score' : (lead.score >= 6 ? 'medium-score' : 'low-score');
      return `
        <div class="lead-card ${border}">
          <div class="lead-header">
            <div class="lead-title">${lead.title}</div>
            <div class="lead-content">${lead.content || ''}</div>
          </div>
          <div class="lead-fields">
            <div class="field"><div class="field-label">üìä SCORE</div><div class="field-value">${lead.score}</div></div>
            <div class="field"><div class="field-label">üí∞ BUDGET</div><div class="field-value">${lead.budget || '‚Äî'}</div></div>
            <div class="field"><div class="field-label">üë§ AUTHOR</div><div class="field-value">${lead.author || '‚Äî'}</div></div>
            <div class="field"><div class="field-label">üè¢ COMPANY</div><div class="field-value">${lead.company || '‚Äî'}</div></div>
            <div class="field"><div class="field-label">üìç LOCATION</div><div class="field-value">${lead.location || '‚Äî'}</div></div>
            <div class="field"><div class="field-label">üíª TECH STACK</div><div class="field-value tech-stack">${lead.techStack && lead.techStack.length > 0 ? lead.techStack.join(', ') : '‚Äî'}</div></div>
            <div class="field"><div class="field-label">üîó LINK</div><div class="field-value"><a style="color:#00aff4" href="${lead.url}" target="_blank">open</a></div></div>
          </div>
          <div class="lead-footer"><span>Freelance Signal Bot</span><span>${new Date(lead.created_ts||Date.now()).toLocaleTimeString()}</span></div>
        </div>`;
    }

    async function refresh(){
      const res = await fetch('/api/leads?limit=50');
      const leads = await res.json();
      document.getElementById('qualifiedLeads').textContent = leads.length;
      document.getElementById('totalScanned').textContent = leads.length;
      const avg = leads.length ? (leads.reduce((a,b)=>a+b.score,0)/leads.length).toFixed(1) : '0.0';
      document.getElementById('avgScore').textContent = avg;
      discordContent.innerHTML = leads.map(leadCard).join('');
    }

    setInterval(refresh, 15000);
    refresh();

    // Supabase Auth Logic
    supabase.auth.onAuthStateChange(async (event, session) => {
      if (session) {
        currentUserId = session.user.id;
        authLoggedOut.style.display = 'none';
        authLoggedIn.style.display = 'flex';
        userEmailSpan.textContent = session.user.email;
        logLine(`User logged in: ${session.user.email}`, 'success');

        // Fetch user profile from your backend
        const profileRes = await fetch(`/api/me?userId=${currentUserId}`);
        const profileData = await profileRes.json();
        if (profileData.profile) {
          logLine(`Profile loaded: ${profileData.profile.status}`, 'info');
          // You can update UI based on subscriptionStatus here if needed
        } else {
          logLine('No profile found for user, creating one...', 'info');
          // This case should ideally be handled by the handle_new_user trigger in Supabase
          // but as a fallback or for initial setup, you might want to trigger a profile creation here
          // For now, we rely on the Supabase trigger.
        }

      } else {
        currentUserId = null;
        authLoggedOut.style.display = 'flex';
        authLoggedIn.style.display = 'none';
        userEmailSpan.textContent = '';
        logLine('User logged out.', 'info');
      }
    });

    signupLoginBtn.onclick = async () => {
      const email = emailInput.value.trim();
      if (!email) {
        alert('Please enter your email address.');
        return;
      }
      try {
        const { error } = await supabase.auth.signInWithOtp({ email });
        if (error) throw error;
        logLine('Check your email for a magic link to log in!', 'info');
      } catch (error) {
        logLine(`Auth error: ${error.message}`, 'error');
        alert(error.message);
      }
    };

    logoutBtn.onclick = async () => {
      try {
        const { error } = await supabase.auth.signOut();
        if (error) throw error;
      } catch (error) {
        logLine(`Logout error: ${error.message}`, 'error');
        alert(error.message);
      }
    };

    async function checkout(plan){
      const email = userEmailSpan.textContent.trim(); // Use the logged-in user's email
      if(!email || !currentUserId) return alert('Please log in first to proceed with checkout.');
      const r = await fetch('/api/checkout',{method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({email, plan, userId: currentUserId})});
      const j = await r.json();
      if (j.url) window.location = j.url; else alert(j.error || 'checkout failed');
    }
    buyMonthlyBtn.onclick = ()=>checkout('monthly');
    buyAnnualBtn.onclick = ()=>checkout('annual');

    logLine('UI loaded. Fetching leads...', 'info');
  </script>
</body>
</html>